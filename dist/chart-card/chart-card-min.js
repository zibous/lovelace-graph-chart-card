/**
 * lovelace-chart-card 2.0.1
 * https://github.com/zibous/lovelace-graph-chart-card
 *
 * License: MIT
 * Generated on 2021
 * Author: Peter siebler
 */

"use strict";import"/hacsfiles/chart-card/chart-min.js?module";const appinfo={name:"✓ custom:chart-card ",app:"chart-card",version:"v2.0.5/v3.1.0",chartjs:Chart.version||"v3.1.0",assets:"/hacsfiles/chart-card/assets/",github:"https://github.com/zibous/lovelace-graph-chart-card"};console.info(`%c ${appinfo.name}          %c ▪︎▪︎▪︎▪︎ ${appinfo.version}  ▪︎▪︎▪︎▪︎`,"color:#FFFFFF; background:#3498db;display:inline-block;font-size:12px;font-weight:300;padding: 6px 0 6px 0","color:#2c3e50; background:#ecf0f1;display:inline-block;font-size:12px;font-weight:300;padding: 6px 0 6px 0");const CT_DATAPOINTSTYLE=["circle","triangle","rectRounded","rect","rectRot","cross","star","line","dash"],CT_CHARTGRIDLINES=["bar","line","bubble","scatter"],CT_NOSHOWSTATES=["bubble","scatter"],CT_BARCHARTS=["bar","horizontalbar"],CT_SHOWLEGEND=["pie","doughnut","polararea","line"],CT_AVIABLETYPES=["line","radar","bar","horizontalBar","pie","doughnut","polarArea","bubble","scatter"],CT_DATASCALEMODES={disabled:{history:!1,timescale:!1,timeaxis:!1},category:{history:!0,timescale:!0,timeaxis:!1},time:{history:!0,timescale:!0,timeaxis:!0},bar:{history:!1,timescale:!1,timeaxis:!1},horizontalbar:{history:!1,timescale:!1,timeaxis:!1},line:{history:!0,timescale:!0,timeaxis:!0},pie:{history:!1,timescale:!1,timeaxis:!1},doughnut:{history:!1,timescale:!1,timeaxis:!1},polararea:{history:!1,timescale:!1,timeaxis:!1},scatter:{history:!1,timescale:!1,timeaxis:!1},radar:{history:!1,timescale:!1,timeaxis:!1},bubble:{history:!1,timescale:!1,timeaxis:!1}},STATE_POS=["left","right","center"],LOADERFILES=["audio","ball-triangle","bars","circles","grid","hearts","oval","pfuff","rings","spinning-circles","tail-spin","three-dots"],DSC_UNITS=["second","minute","hour","day","month","year"],DSC_RANGES=["max","min","range","midrange","mean","sum","last","first"],API_DATAMODE={history:1,statemode:2},SERIESDEFAULT_VALUE=0,TRANSFORM_MODE={statebased:1,datalabel:2,seriesdata:3};function setChartDefaults(t){if(window.Chart3&&window.Chart3.defaults){if(window.Chart3.defaults.theme&&t.theme==window.Chart3.defaults.theme)return;window.Chart3.defaults.theme=t.theme,window.Chart3.defaults.responsive=!0,window.Chart3.defaults.maintainAspectRatio=!1,window.Chart3.defaults.hoverOffset=8,t.useAnimations||(window.Chart3.defaults.animation=0),window.Chart3.defaults.locale=t.locale,window.localeNames=getLocaleText(window.Chart3.defaults.locale),window.Chart3.defaults.font.family=t.font,window.Chart3.defaults.color=convertColor(t.fontColor),window.Chart3.defaults.layout.padding.top=t.padding.top||0,window.Chart3.defaults.layout.padding.bottom=t.padding.bottom||0,window.Chart3.defaults.layout.padding.left=t.padding.left||0,window.Chart3.defaults.layout.padding.right=t.padding.right||0,window.Chart3.defaults.plugins.legend.labels.color=convertColor(t.fontColor),window.Chart3.defaults.plugins.legend.position="top",window.Chart3.defaults.plugins.legend.labels.usePointStyle=!0,window.Chart3.defaults.plugins.legend.labels.boxWidth=8,window.Chart3.defaults.plugins.legend.show=!1,window.Chart3.defaults.plugins.tooltip.backgroundColor=convertColor(t.tooltipsBackground),window.Chart3.defaults.plugins.tooltip.titleColor=convertColor(t.tooltipsFontColor),window.Chart3.defaults.plugins.tooltip.bodyColor=convertColor(t.tooltipsFontColor),window.Chart3.defaults.plugins.tooltip.footerColor=convertColor(t.tooltipsFontColor),window.Chart3.defaults.plugins.tooltip.enabled=!0,window.Chart3.defaults.elements.arc.borderWidth=0,window.Chart3.defaults.elements.line.fill=!1,window.Chart3.defaults.elements.line.tension=.225,window.Chart3.defaults.elements.point.borderWidth=0,window.Chart3.defaults.elements.point.hoverRadius=8,window.Chart3.defaults.elements.point.hitRadius=8,window.Chart3.defaults.scale.grid.drawBorder=!0,window.Chart3.defaults.scale.grid.borderWidth=parseFloat((1.1*t.gridLineWidth).toFixed(3))||1,window.Chart3.defaults.scale.grid.color=convertColor(t.gridlineColor,.8),window.Chart3.defaults.scale.grid.lineWidth=t.gridLineWidth,window.Chart3.defaults.scale.grid.borderDash=t.borderDash,window.Chart3.defaults.scale.grid.lineWidth=(e=>0===e.index?0:t.gridLineWidth||1),window.Chart3.defaults.scale.grid.borderColor=convertColor(t.zeroLineColor),window.Chart3.defaults.scale.alignToPixels=!0,window.Chart3.defaults.scales.radialLinear.ticks.backdropColor="transparent",window.gradient&&window.Chart3.register(window.gradient)}}window.Chart3=Chart;const gradient=window["chartjs-gradient"],fireEvent=(t,e,a,i)=>{i=i||{},a=null==a?{}:a;const s=new Event(e,{bubbles:void 0===i.bubbles||i.bubbles,cancelable:Boolean(i.cancelable),composed:void 0===i.composed||i.composed});return s.detail=a,t.dispatchEvent(s),s},style=document.createElement("style");style.innerHTML="\n    html {\n        scrollbar-width: none; \n        -ms-overflow-style: none;\n    }\n\n    html::-webkit-scrollbar {\n        width: 0px;\n    }\n    .card-header{\n        padding-bottom:0 !important;\n        white-space:nowrap;\n    }\n    .card-header-icon{\n        position:relative;\n        top:-2px;\n        padding:0 6px 0 4px;\n    }\n    .card-header-title{\n        overflow:hidden;\n        text-overflow:ellipsis;\n        white-space:nowrap;\n        display:inline-block;\n        vertical-align:top;\n        width:70%;\n    }\n    .card-content{\n        overflow: auto;\n    }\n    .card-canvas{\n        -moz-user-select: none; \n        -webkit-user-select: none; \n        -ms-user-select: none;\n        width:100%;\n        height:auto;\n    }\n    .card-loader{\n        width: 60px;\n        position:absolute;\n        top:42%;\n        left:38%;\n        width:60px;\n        z-index:500;\n        margin: 0 auto\n    }\n    .card-state-view{\n        position:absolute;\n        top:12px;\n        right:20px;\n        background-color:transparent;\n        z-index:100;\n    }\n    .state-view-data{\n        font-weight:400;\n        margin:0;\n        cursor:pointer;\n        height:4.5em;\n        overflow:auto;\n    }\n    .state-view-value{\n        font-size:2.0em;\n        line-height:1.2em;\n        text-align:right;\n        margin:0;\n        color:#fff;\n        border-bottom: 1px dotted\n    }\n    .state-view-value span{\n        padding-left: 4px;\n        font-size:0.4em;\n        vertical-align:top\n    } \n    .state-view-name{\n        border:none;\n        font-size:0.85em;\n        text-align:center;\n        margin:0;\n        line-height:2em\n    } \n    .card-detail-view{\n        margin-top: 1.925em;\n    }\n    .card-detail-view  hr{\n        border-bottom-width: 0px;\n        opacity:0.5;\n    }   \n    .card-detail-view h2{\n        margin-left: 0.5em\n    }\n    .card-detail-table{\n        margin: 0 auto;\n        font-size:0.925em;\n        font-weight:300;\n        width: 95%;\n        border-collapse: collapse !important;\n        table-layout: fixed;\n        text-align:left;\n        line-height: 1.8rem\n    }\n    table-row-background-color\n\n    .card-detail-table  tr:nth-child(even) {background: var(--table-row-background-color)}\n    .card-detail-table  tr:nth-child(odd) {background:var(--table-row-alternative-background-color)}\n\n    .card-detail-table th{\n        padding: 0 6px;\n        font-weight:400;\n    }\n    .card-detail-table td{\n        padding: 0 6px;\n        overflow:hidden;\n        text-overflow:ellipsis;\n        white-space:nowrap;\n        font-weight:300;\n    }\n    .card-timestamp{\n        position:absolute;\n        right:0.8em;\n        bottom:0;\n        font-weight:300;\n        font-size:0.7em;\n        text-align:right;\n        z-index:800\n        color: #000000;\n    }\n    @media (min-width: 320px) and (max-width: 480px){\n    \n    }\n";class ChartCard extends HTMLElement{constructor(){super(),this._hass=null,this._config=null,this.attachShadow({mode:"open"}),this.card_icon=null,this.card_title=null,this.card_height=240,this.theme="",this.themeSettings=null,this.graphChart=null,this.chart_type="bar",this.chart_locale="de-DE",this.chart_update=!1,this.ctx=null,this.chartconfig=null,this.graphData={},this.hassEntities=[],this.entity_items=new Entities(null,!1),this.entity_options=null,this.updateTimer=-1,this.update_interval=6e4,this.skipRender=!1,this.lastUpdate=null,this.ready=!1,this.updating=!1,this._initialized=!1,this.initial=!0,this.dataInfo={starttime:new Date,endtime:new Date,entity_items:null,entities:"",group_by:"1h",time:(new Date).getTime(),loading:!1,url:"",prev_url:"not_set",param:"",options:""},this.DEBUGMODE=0,this.DEBUGDATA={API:{}},this.APISTART=performance.now(),this.DEBUGDATA.API.elapsed_total=0,this.DEBUGDATA.PROFILER={}}_evaluateCssVariable(t){try{return getComputedStyle(document.documentElement).getPropertyValue(t).trim()}catch(e){console.error("ERROR evaluateCssVariable:",t,"ERROR",e.message,e)}return t}_setDefaultThemeSettings(){this.themeSettings={theme:{theme:"system",dark:!1},fontColor:"#1E1E1E",fontFamily:"Quicksand, Roboto,'Open Sans','Rubik','Helvetica Neue', 'Helvetica', 'Arial', sans-serif",gridlineColor:"1E1E1E",zeroLineColor:"#333333",tooltipsBackground:"#ecf0f1",tooltipsFontColor:"#647687",showGridLines:CT_CHARTGRIDLINES.includes(this.chart_type.toLowerCase())||!1,secondaryAxis:!1,gridLineWidth:1,borderDash:[1,1],padding:{top:20,right:24,bottom:12,left:24},useAnimations:!0,locale:this.chart_locale}}_getThemeSettings(){this._setDefaultThemeSettings();try{return this.themeSettings.fontColor=this.chart_themesettings&&this.chart_themesettings.fontcolor||this._evaluateCssVariable("--chartjs-text-fontColor")||this._evaluateCssVariable("--primary-text-color")||this.themeSettings.fontFamily,this.themeSettings.fontFamily=this._evaluateCssVariable("--chartjs-fontFamily")||this._evaluateCssVariable("--paper-font-common-base_-_font-family")||"Quicksand, Roboto,'Open Sans','Rubik','Helvetica Neue', 'Helvetica', 'Arial', sans-serif",this.themeSettings.gridlineColor=this.chart_themesettings&&this.chart_themesettings.gridlinecolor||this._evaluateCssVariable("--chartjs-gridline-color")||this._evaluateCssVariable("--light-primary-color")||this.themeSettings.gridlineColor,this.themeSettings.zeroLineColor=this.chart_themesettings&&this.chart_themesettings.zerolinecolor||this._evaluateCssVariable("--chartjs-zero-gridline-color")||this._evaluateCssVariable("--dark-primary-color")||this.themeSettings.zeroLineColor,this.themeSettings.tooltipsBackground=this.chart_themesettings&&this.chart_themesettings.tooltipsbackground||this._evaluateCssVariable("--chartjs-tooltip-background")||this.themeSettings.tooltipsBackground,this.themeSettings.tooltipsFontColor=this.chart_themesettings&&this.chart_themesettings.tooltipsfontcolor||this._evaluateCssVariable("--chartjs-text-fontcolor")||this.themeSettings.tooltipsFontColor,this.themeSettings.showGridLines=CT_CHARTGRIDLINES.includes(this.chart_type.toLowerCase())||!1,this.themeSettings.secondaryAxis=!1,this.themeSettings.themecolorused=this._evaluateCssVariable("--chartjs-theme")||!1,this.themeSettings.useAnimations=this._evaluateCssVariable("--chart-animantions")||this.themeSettings.useAnimations,void 0!==this.theme&&void 0!==this.theme.dark||(this.theme={theme:"system",dark:"dark"===this.themeSettings.themecolorused||!1},this.themeSettings.theme=this.theme),this.theme&&null!=this.theme.dark&&(this.themeSettings.theme=this.theme),this.themeSettings.gridLineWidth=this.themeSettings.theme.dark?.8:1,this.themeSettings.borderDash=[1,1],this.chartconfig.options&&this.chartconfig.options.scale&&this.chartconfig.options.scale.gridLines&&(this.themeSettings.showGridLines=!0),this.chartconfig.options&&this.chartconfig.options.legend&&(this.themeSettings.showLegend=!0),this.DEBUGMODE&&(this.DEBUGDATA.THEMESETTINGS=this.themeSettings),setChartDefaults(this.themeSettings),!0}catch(t){console.error("Fatal Error theme settings",t.message,t)}return!1}_setChartConfig(){if(this._getThemeSettings(),this.ctx){let t={ctx:this.ctx,canvasId:this.canvasId,entity_items:this.entity_items,chart_type:this.chart_type,chartconfig:this.chartconfig,loader:this.loader,debugmode:this.DEBUGMODE,debugdata:this.DEBUGDATA};this.graphChart=new graphChart(t)}else console.error("No chart.js container found !")}_creatHACard(){if(this.id)return;this.id="TC"+Math.floor(1e3*Math.random());const t=document.createElement("ha-card");t.setAttribute("class","graph-card"),t.id=this.id+"-card",t.setAttribute("data-graphtype",this.chart_type),this.chart_themesettings&&this.chart_themesettings.cardbackground&&(t.style.cssText+=`background: ${this.chart_themesettings.cardbackground} !important;`);const e=document.createElement("div");if(e.setAttribute("class","card-content"),e.id=this.id+"-view",e.style.height=cssAttr(this.card_height),this.card_title||this.card_icon){const e=document.createElement("div");if(e.setAttribute("class","card-header header flex"),e.id=this.id+"-header",this.card_icon){const t=document.createElement("ha-icon");t.setAttribute("class","card-header-icon"),t.setAttribute("icon",this.card_icon),e.appendChild(t)}if(this.card_title){const t=document.createElement("span");t.setAttribute("class","card-header-title"),t.innerHTML=this.card_title,e.appendChild(t)}t.append(e)}this.canvasId=this.id+"-chart";const a=document.createElement("canvas");a.setAttribute("class","card-canvas"),this.ctx=a.getContext("2d"),a.id=this.canvasId;let i=10;this.showstate&&"center"===this.showstate&&(i=60),a.height=this.card_height-i,a.style.height=cssAttr(this.card_height-i),a.style.maxHeight=cssAttr(this.card_height-i),a.style.display="block",this.loaderart&&(this.loader=document.createElement("img"),this.loader.setAttribute("class","card-loader"),this.loader.id=this.id+"-loader",this.loader.alt="loading...",this.loader.style.width="60",this.loader.src=appinfo.assets+this.loaderart+".svg"),this.chart_showstate&&(this.currentData=document.createElement("div"),this.currentData.setAttribute("class","card-state-view"),this.currentData.id=this.id+"state-view"),this.chart_showdetails?(this.detailData=document.createElement("div"),this.detailData.setAttribute("class","card-detail-view"),this.detailData.id=this.id+"detail-info",this.currentData.setAttribute("data-view",this.detailData.id)):e.style.maxHeight=cssAttr(this.card_height),e.appendChild(a),this.loader&&e.append(this.loader),this.chart_showdetails&&this.detailData&&e.append(this.detailData),t.appendChild(e),this.chart_showstate&&this.currentData&&t.appendChild(this.currentData),this.card_timestamp&&(this.timestampLayer=document.createElement("div"),this.timestampLayer.setAttribute("class","card-timestamp"),this.timestampLayer.id=this.id+"detail-footertext",this._renderCardTimestamp(),t.appendChild(this.timestampLayer)),this.card=t,this.root.appendChild(t)}_checkLocale(t){try{Intl.getCanonicalLocales(t)}catch(t){return console.error(" RangeError: invalid language tag:",this.config),navigator.language||navigator.userLanguage}return t}getEntities(){const t=this._config.entities||[];if(!t||0===t.length)return;const e=this._config.entities.filter(t=>null!=t.entity_filter),a=this._config.entities.filter(t=>null!=t.entity);if(this._hass&&this._hass.states&&e&&e.length){return[...a,...filter(this._hass.states,e)]}return t}_checkDatascales(){this.datascales=Object.assign({},this._config.datascales),this.datascales.chart=this.chart_type.toLowerCase(),this.datascales.cardtitle=this.card_title,this.datascales.range=this.datascales.range||0,void 0===this.datascales.mode?this.datascales.mode=CT_DATASCALEMODES[this.datascales.chart]:this.datascales.mode=CT_DATASCALEMODES[this.datascales.mode]||CT_DATASCALEMODES[this.datascales.chart],0===this.datascales.range||this.datascales.mode.history||(this.datascales.mode.history=!0),"line"===this.chart_type&&0===this.datascales.range&&(this.datascales.range=24,this.datascales.unit="hour",this.datascales.format=this.datascales.format||this.datascales.unit),this.datascales.range&&(this.datascales.unit=this.datascales.unit||"day",this.datascales.format=this.datascales.format||"day",this.datascales.ignoreZero=this.datascales.ignoreZero||!0,this.datascales.aggregate=this.datascales.aggregate||"last"),this.datascales.unit&&0==DSC_UNITS.includes(this.datascales.unit.toLowerCase())&&(this.datascales.range=24,this.datascales.unit="day",this.datascales.format=this.datascales.format||this.datascales.unit),this.datascales.aggregate&&0==DSC_RANGES.includes(this.datascales.aggregate.toLowerCase())&&(this.datascales.aggregate="last"),this.datascales.factor=this.datascales.factor||1,this.datascales.isoWeekday=this.datascales.isoWeekday||1}setConfig(t){if(!t.entities)throw new Error("You need to define an entity");try{if(this._config)return void console.error("CHART-CART Config",t.title," allready loaded...");for(this.root=this.shadowRoot;this.root.hasChildNodes();)this.root.removeChild(root.lastChild);const e=style.cloneNode(!0);if(this.root.appendChild(e),this._config=Object.assign({},t),this._config.chart=this._config.chart||"bar",this.DEBUGMODE=this._config.debug||this.DEBUGMODE,this.card_title=this._config.title||"",this.card_icon=this._config.icon||null,this.card_height=this._config.height||240,this.card_timestamp=this._config.cardtimestamp||!0,this.chart_type=this._config.chart||"bar",this._config.id=this.chart_type+Math.floor(1e3*Math.random()),this.chart_showstate=this._config.showstate||!1,this.chart_showstate=!0===this.chart_showstate?"right":this.chart_showstate,this.chart_showstate&&(STATE_POS.includes(this.chart_showstate.toLowerCase())||(this.chart_showstate=!1)),this.chart_showdetails=this._config.showdetails||!1,this.chart_showdetails=""!=(this.chart_showdetails.title_mean||""+this.chart_showdetails.title_min||""+this.chart_showdetails.title_max||""),this.chart_showdetails=this._config.showdetails,this.chart_themesettings=this._config.theme||null,this.loaderart=this._config.loader||"three-dots",LOADERFILES.includes(this.loaderart)||(this.loaderart="spinning-circles"),!this.chart_type)throw new Error("You need to define type of chart");if(!CT_AVIABLETYPES.includes(this.chart_type))throw new Error("Invalid config for 'chart:'"+this.chart_type+". Available options are: "+availableTypes.join(", "));"horizontalbar"===this.chart_type.toLowerCase()&&(this.chart_type="bar"),this.chartconfig={},this.chartconfig.type=this.chart_type,(this._config.options||this._config.chartOptions)&&(this.chartconfig.options=this._config.options||this._config.chartOptions),this.chart_locale=navigator.language||navigator.userLanguage||"DE",this._checkLocale(),this._checkDatascales(),this.update_interval=1e3*this._config.update_interval||this.update_interval,CT_NOSHOWSTATES.includes(this.chart_type.toLocaleLowerCase())?this.chart_showstate=!1:0===this.datascales.range&&this.chart_showstate&&(this.chart_showstate=!1),this.chart_showstate=1==this.chart_showstate?"right":this.chart_showstate,!1===this._initialized&&this._creatHACard()}catch(e){console.error(e.message,t,e)}}setEntity_itemsData(t){if(!1===this.ready&&this.entity_items.getSize()!==this.hassEntities.length){this.entity_options=null,this.entity_items=new Entities(null);for(const e of t){if(e.options)this.entity_options=Object.assign({},e.options);else{const t=this.hassEntities.find(t=>t.entity_id===e.entity);if(t){let a=this.entity_items.getEntity(e.entity)||Object.assign({},e);t.attributes&&(void 0===a.name&&(a.name=t.attributes.friendly_name||a.name),a.unit=t.attributes.unit_of_measurement||a.unit||""),void 0!==a.name&&(a.last_changed=t.last_changed,a.state=t.state||0,a.value=t.state||0,a.datascales=this.datascales,a.datascales.ignoreZero=a.ignoreZero||this.datascales.ignoreZero||!1,a.datascales.aggregate=a.aggregate||this.datascales.aggregate||"last",a.datascales.factor=a.factor||this.datascales.factor,a.datascales.useStatistics=this.chart_showdetails||!1,a.state=a.state*a.datascales.factor,a.factor=a.datascales.factor,a.attribute&&(a.state=(t.attributes[a.attribute]||0)*a.factor),a.chart=this.chart_type,this.entity_items.addEntity(a))}}null===this.entity_options?this.entity_options={settings:!1,mode:this.datascales.mode||CT_DATASCALEMODES.disabled}:this.entity_options.mode=this.entity_options.mode||this.datascales.mode||CT_DATASCALEMODES.disabled}return this.entity_items.isValid()||!1}return!1}set hass(t){if(void 0===t)return;this.timeOut&&clearTimeout(this.timeOut),this._hass=t;const e=this._hass.language||navigator.language||navigator.userLanguage||"en-GB";this.chart_locale!==e&&(this.chart_locale=e,window.localeNames=getLocaleText(e),window.Chart3.defaults.locale=e,this._getThemeSettings(),this.graphChart&&(this.themeSettings.theme=this.theme,this.updateGraph(!0))),this.selectedTheme=t.selectedTheme||{theme:"system",dark:!1},this.theme&&this.theme.dark!==this.selectedTheme.dark&&(this.theme=this.selectedTheme,this._getThemeSettings(),this.graphChart&&(this.themeSettings.theme=this.theme,this.updateGraph(!0))),this.theme=this.selectedTheme;const a=this.getEntities();a?(this.hassEntities=a.map(e=>t.states[e.entity]).filter(t=>void 0!==t),this.hassEntities&&0!==this.hassEntities.length?this.skipRender&&!1===this.updating&&0===this.update_interval?this.checkUpdate():(this.ready=this.setEntity_itemsData(a),this.timeOut=setTimeout(()=>{this.updateGraph(!1)},this.initial?200:this.update_interval),this.skipRender=!0):console.error(this.chart_type,"No valid entities found, check your settings...")):console.error(this.chart_type,"No valid entities found, check your settings...")}updateGraph(t){t="undefined"===t?!this.initial:t,!0!==this.updating&&(this.graphChart||(this._getThemeSettings(),this.themeSettings.theme=this.theme,this._setChartConfig(),t=!1),this.graphChart&&(this.updating=!0,this._getThemeSettings(),this.themeSettings.theme=this.theme,this.entity_items.getSize&&(this.graphChart.entityData=this.entity_items.getData(),this.chart_update=t,this._getHistory(),this._renderCardTimestamp()),this.updating=!1,this.initial=!1))}checkUpdate(){if(!0===this.updating)return!1;this.hasChanged=!1;const t=this.entity_items.getEntitieslist();return this.hassEntities&&this.hassEntities.length&&this._hass&&(this.hassEntities=t.map(t=>this._hass.states[t.entity]).filter(t=>void 0!==t),this.hasChanged=this.entity_items.hasChanged(this.hassEntities),this.hasChanged&&this.updateGraph(!0)),this.hasChanged}_getHistory(){if(1!=this.dataInfo.loading&&(!this.card||0!=this.card.getClientRects().length)&&(this.ready=this.entity_items.isValid(),this.ready))if(this.datascales.range>0){if(this.APISTART=performance.now(),this.DEBUGDATA.PROFILER.GETHASSDATA={start:performance.now()},this.dataInfo.time=(new Date).getTime(),this.dataInfo.starttime=new Date,this.datascales.range<1?this.dataInfo.starttime.setMinutes(this.dataInfo.starttime.getMinutes()-60*this.datascales.range):this.dataInfo.starttime.setHours(this.dataInfo.starttime.getHours()-this.datascales.range),this.dataInfo.endtime=new Date,this.dataInfo.entities=this.entity_items.getEntityIdsAsString(),this.dataInfo.entity_items=this.entity_items.items,this.dataInfo.useAlias=this.entity_items.useAliasFields(),this.dataInfo.ISO_startime=this.dataInfo.starttime.toISOString(),this.dataInfo.ISO_endtime=this.dataInfo.endtime.toISOString(),this.dataInfo.options="&skip_initial_state",this.dataInfo.options+=`&significant_changes_only=${this.dataInfo.useAlias?1:0}`,this.dataInfo.useAlias||(this.dataInfo.options+="&minimal_response"),this.dataInfo.param==`${this.dataInfo.endtime}:${this.dataInfo.entities}`)return void console.warn("Data allready loaded...");if(this.dataInfo.param=`${this.dataInfo.endtime}:${this.dataInfo.entities}`,this.dataInfo.url=`history/period/${this.dataInfo.ISO_startime}?end_time=${this.dataInfo.ISO_endtime}&filter_entity_id=${this.dataInfo.entities}${this.dataInfo.options}`,this.dataInfo.url!==this.dataInfo.prev_url){this.dataInfo.loading=!0;this._hass.callApi("GET",this.dataInfo.url).then(t=>this._buildGraphData(t,API_DATAMODE.history),()=>null);this.dataInfo.prev_url=this.dataInfo.url}}else this._buildGraphData(null,API_DATAMODE.statemode)}renderStateData(t){let e=[];if(this.currentData&&this.chart_showstate&&t){let a="margin:0;line-height:1.2em";e.push(`<div class="state-view-data ${this.chart_showstate}">`);for(const i of t){let t=' style="'+a+";color:"+i.color+'"';e.push('<div class="stateitem" id="'+i.name+'"'+t+'">'),e.push('<p class="state-view-value" style="color:'+i.color+';">'+_formatNumber(this.chart_locale,i.current||0)+"<span>"+i.unit+"</span></p>"),e.push('<p class="state-view-name">'+i.name+"</p>"),e.push("</div>")}e.push("</div>"),this.currentData.innerHTML=e.join("")}if(this.currentData&&this.detailData&&t){const t=this.entity_items.getStatisticData();t&&((e=[]).push(`<hr color="${this.themeSettings.gridlineColor}" size="0.25"/>`),this.chart_showdetails.title&&e.push(`<h2>${this.chart_showdetails.title}</h2>`),e.push('<div><table class="card-detail-table">'),e.push("<tr>"),e.push(`<th width="20%"><b>${this.chart_showdetails.title_sensor||"Statitics"}</b></th>`),this.chart_showdetails.title_min&&""!=this.chart_showdetails.title_mean&&e.push(`<th align="right">${this.chart_showdetails.title_mean}</th>`),this.chart_showdetails.title_min&&""!=this.chart_showdetails.title_min&&e.push(`<th align="right">${this.chart_showdetails.title_min}</th>`),this.chart_showdetails.title_min&&""!=this.chart_showdetails.title_max&&e.push(`<th align="right">${this.chart_showdetails.title_max}</th>`),e.push(`<th align="right">${this.chart_showdetails.title_current}</th>`),e.push(`<th>${this.chart_showdetails.title_timestamp||"Timestamp"}</th>`),e.push("</tr>"),t.forEach(t=>{e.push("<tr>"),e.push('<td><span style="font-size:4em;color:'+t.color+';vertical-align:top;padding-right:8px">&bull;</span>'+t.name+"</td>"),this.chart_showdetails.title_min&&""!=this.chart_showdetails.title_mean&&e.push("<td align='right'>"+_formatNumber(this.chart_locale,t.mean||0)+" "+t.unit+"</td>"),this.chart_showdetails.title_min&&""!=this.chart_showdetails.title_min&&e.push("<td align='right'>"+_formatNumber(this.chart_locale,t.min||0)+" "+t.unit+"</td>"),this.chart_showdetails.title_min&&""!=this.chart_showdetails.title_max&&e.push("<td align='right'>"+_formatNumber(this.chart_locale,t.max||0)+" "+t.unit+"</td>"),e.push("<td align='right'>"+_formatNumber(this.chart_locale,t.current||0)+" "+t.unit+"</td>"),e.push("<td>"+localDatetime(t.timestamp,this.chart_locale)+"</span>"),e.push("</tr>")}),e.push("</table></div><br/>"),e.length&&(this.detailData.innerHTML=e.join("")))}}_renderCardTimestamp(){this.card_timestamp&&this.timestampLayer&&(this.timestampLayer.innerHTML=localDatetime((new Date).toISOString()))}_renderDebugInfo(){this.DEBUGMODE&&(this.DEBUGDATA.CARD=this.card_title,this.DEBUGDATA.API.updateIntervall=msToTime(this.update_interval),this.DEBUGDATA.API.elapsed_total=msToTime(performance.now()-this.APISTART),this.DEBUGDATA.API.datainfo=this.dataInfo,this.DEBUGDATA.DATA_ENTITIES=this.entity_items.items,this.DEBUGDATA.LOVELACE_CONFIG=this._config,this.DEBUGDATA.LOCALEINFO=window.localeNames,"History"==this.DEBUGDATA.API.datamode&&this.DEBUGDATA.PROFILER&&(delete this.DEBUGDATA.PROFILER.GETHASSDATA.start,delete this.DEBUGDATA.PROFILER.GETBUCKETDATA.start),console.info(`%cDEBUGDATA ${this.chart_type.toUpperCase()} ${appinfo.name} ${appinfo.version}:`,"color:white;background:#cc283a;padding:4px",this.DEBUGDATA))}_buildGraphData(t,e){if(this.DEBUGMODE&&(this.DEBUGDATA.API.datamode=e==API_DATAMODE.history?"History":"Current",e==API_DATAMODE.history&&(this.DEBUGDATA.PROFILER.GETHASSDATA.elapsed=msToTime(performance.now()-this.DEBUGDATA.PROFILER.GETHASSDATA.start),this.DEBUGDATA.PROFILER.GETBUCKETDATA={start:performance.now()})),e===API_DATAMODE.history&&!t||t&&!t.length)return this.DEBUGMODE&&(this.DEBUGDATA.API.ERROR="No Historydata found!",this._renderDebugInfo()),this.dataInfo.loading=!1,null;if(!this.entity_items.isValid)return this.DEBUGMODE&&(this.DEBUGDATA.API.ERROR="No valid Entities found!",this.DEBUGDATA.API.DATA=t,this._renderDebugInfo()),this.dataInfo.loading=!1,null;if(e==API_DATAMODE.history){if(0==new DataProvider({datainfo:this.dataInfo,datascales:this.datascales,debugmode:this.DEBUGMODE,debugdata:this.DEBUGDATA}).getSeriesdata(t,this.chart_type))return this.DEBUGMODE&&(this.DEBUGDATA.API.DATA=t,this.DEBUGDATA.API.ERROR="Transform Historydata failed!",this._renderDebugInfo()),this.dataInfo.loading=!1,null}const a=new chartData({card_config:{title:this.cardTitle,chart:this._config.chart.toLowerCase(),chartOptions:this.chartconfig.options},entity_items:this.entity_items,entityOptions:this.entity_options,debugmode:this.DEBUGMODE,debugdata:this.DEBUGDATA});if(e===API_DATAMODE.history?(this.graphData=a.getHistoryGraphData(),this.lastUpdate=(new Date).toISOString()):(this.graphData=a.getCurrentGraphData(),this.lastUpdate=(new Date).toISOString()),null===this.graphData)return this.DEBUGMODE&&(this.DEBUGDATA.API.ERROR="No GraphData found!",this.DEBUGDATA.API.DATA=t,this._renderDebugInfo()),this.dataInfo.loading=!1,null;if(this.graphData&&this.graphData.config&&(this.themeSettings.secondaryAxis=this.graphData.config.secondaryAxis||!1),this.chart_update?this.graphChart&&this.graphData&&(this.graphChart.graphData=this.graphData,this.graphChart.renderGraph(!0)):this.graphChart&&this.graphData&&(this.graphChart.graphData=this.graphData,this.graphChart.renderGraph(!1)),this._renderCardTimestamp(),e===API_DATAMODE.history){if(this.chart_showstate){let t=this.graphData.data.datasets.map(function(t){return{name:t.label||"",min:t.minval,max:t.maxval,avg:null,sum:null,current:t.current,unit:t.unit||"",color:t.labelcolor||t.backgroundColor,timestamp:t.last_changed||""}});t&&this.renderStateData(t)}return this.DEBUGMODE&&(this.DEBUGDATA.PROFILER.GETBUCKETDATA.elapsed=msToTime(performance.now()-this.DEBUGDATA.PROFILER.GETBUCKETDATA.start),this._renderDebugInfo()),this.dataInfo.loading=!1,!0}this.DEBUGMODE&&this._renderDebugInfo(),this.dataInfo.loading=!1}connectedCallback(){this._initialized=!0,0!==this.update_interval&&(this.updateTimer=setInterval(()=>{!1===this.updating&&this.checkUpdate()},this.update_interval))}disconnectedCallback(){this._initialized=!1,this.updateTimer&&clearInterval(this.updateTimer)}getCardSize(){return 1}}customElements.define("chart-card",ChartCard);class Entities{constructor(t){this.items=t||{}}addEntity(t){this.items[t.entity]=t}setData(t,e){this.items[t]=e}setDataField(t,e,a){this.items[t][e]=a}getSize(){return this.getEntityIds().length}isValid(){return 0!=this.getSize()}useAliasFields(){let t=0;return this.getEntityIds().forEach(e=>{this.items[e];t+=this.items[e].attribute?1:0}),0!=t}hasChanged(t){let e=!1;if(t&&t.length){const a=this.getEntitieslist();for(let i of a){const a=t.find(t=>t.entity_id===i.entity);i.laststate=i.state,i.update=!1,a&&i.last_changed!==a.last_changed&&i.state!==a.state&&(i.last_changed=a.last_changed,i.state=a.state,i.update=!0,e=!0)}}return e}getEntity(t){return Number.isInteger(t)?this.getEntitieslist()[t]:this.items[t]}getNames(){return this.getAttribute("name")}getAttribute(t){let e=this.items;return Object.keys(e).map(function(a){return e[a][t]}).filter(t=>void 0!==t)}getOptions(t,e){const a=this.getEntity(t);return a&&a.style&&!e?a.style:a&&a.style&&void 0!==a.style[e]?a.style[e]:{}}getDataScales(t){const e=this.getEntity(t);return e?e.datascales:{range:24,unit:"day",format:"MMM d",factor:1,ignoreZero:!0,aggregate:"last"}}getStyle(t){return this.getEntity(t).style}getColors(){const t=this.items;return Object.keys(t).map(function(e){if(void 0!==(t[e].style&&t[e].style.color)||void 0!==(t[e].style&&t[e].style.backgroundColor))return t[e].style.color||t[e].style.backgroundColor}).filter(t=>void 0!==t)}getData(t=null){return t?this.items[t].state:this.getAttribute("state")}getEntityIds(){return Object.keys(this.items)}getEntityIdsAsString(){const t=Object.keys(this.items).map(t=>this.items[t].entity);return[...new Set(t)].join(",")}getEntities(){return Object.entries(this.items)}getEntitieslist(){const t=this.items;return Object.keys(t).map(function(e){return t[e]})}getItemLabels(t){this.getEntity(t).labels}getItemData(t){this.getEntity(t).seriesdata.data}getDataset(t){if(this.items[t].seriesdata&&this.items[t].seriesdata.data){const e=this.items[t].seriesdata.data;let a=[],i=[];return e.forEach(t=>{a.push(t.localedate),i.push(t.y)}),{labels:a,data:i}}return{labels:[],data:[]}}getStatisticData(){let t=[];return this.getEntitieslist().forEach(e=>{let a={};if(e.seriesdata&&e.seriesdata.data){const t=e.seriesdata.data.map(t=>t.y);t.length&&(a.max=arrStatistics.max(t),a.min=arrStatistics.min(t),a.sum=arrStatistics.sum(t),a.mean=arrStatistics.mean(t),a.last=t[t.length-1],a.first=t[0])}a.name=e.name,a.entity=e.entity,a.color=e.style.backgroundColor||e.style.color,a.current=e.state,a.unit=e.unit||"",a.timestamp=e.last_changed,t.push(a)}),t}getSeriesData(){let t=[];const e=this.getEntityIds();for(const a of e){const e=this.items[a];e.seriesdata&&t.push(e.seriesdata)}return t}}function convertColor(t,e=1){return window.Chart3&&window.Chart3.helpers&&window.Chart3.helpers.color&&window.Chart3.helpers.color(t).alpha(e).rgbString()||t}function logInfo(t,...e){t&&console.info(`%cLOGINFO ${(new Date).toISOString()}:`,"color:white;background:#0275d8;padding:4px",...e)}const cssAttr=function(t){return"number"==typeof t?t+"px":t},_parseNumber=t=>t===parseInt(t)?Number(parseInt(t)):Number(parseFloat(t).toFixed(3)),roundToBase=(t=0,e=3)=>Math.pow(e,Math.floor(Math.log(t)/Math.log(e))),_formatNumber=(t,e)=>new Intl.NumberFormat(t).format(_parseNumber(e)),_safeParseFloat=function(t){return t=parseFloat(t),isFinite(t)?+t.toFixed(3):0};function msToTime(t){var e=parseInt(t%1e3),a=parseInt(t/1e3%60),i=parseInt(t/6e4%60),s=parseInt(t/36e5%24);return(s=s<10?"0"+s:s)+":"+(i=i<10?"0"+i:i)+":"+(a=a<10?"0"+a:a)+"."+e}function strToDate(t){if(!t)return null;const e=new Date(t.replace(/-|\ |\./gi,"/"));return isNaN(e)?(console.error("Not a valid date string",t),null):e}function localDatetime(t,e="at-DE"){if(!t)return"";e||(e=navigator.language||navigator.userLanguage||"en-GB");const a=new Date(t);return isNaN(a)?t:new Intl.DateTimeFormat(e,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format(a)}function checkDate(t){return t=t||new Date,isNaN(t)||"object"==typeof t?"string"==typeof t&&(t=new Date(t)):t=new Date(1e3*t),t}function getLocaleText(t="DE"){return{days_narrow:[...Array(7).keys()].map(e=>new Intl.DateTimeFormat(t,{weekday:"narrow"}).format(new Date(Date.UTC(2021,5,e)))),days_short:[...Array(7).keys()].map(e=>new Intl.DateTimeFormat(t,{weekday:"short"}).format(new Date(Date.UTC(2021,5,e)))),days_long:[...Array(7).keys()].map(e=>new Intl.DateTimeFormat(t,{weekday:"long"}).format(new Date(Date.UTC(2021,5,e)))),month_narrow:[...Array(12).keys()].map(e=>new Intl.DateTimeFormat(t,{month:"narrow"}).format(new Date(Date.UTC(2021,e,1)))),month_short:[...Array(12).keys()].map(e=>new Intl.DateTimeFormat(t,{month:"short"}).format(new Date(Date.UTC(2021,e,1)))),month_long:[...Array(12).keys()].map(e=>new Intl.DateTimeFormat(t,{month:"long"}).format(new Date(Date.UTC(2021,e,1))))}}Date.prototype.getWeek=function(t=0){var e=new Date(this.getFullYear(),0,1);return t=t||0,Math.floor(((this-e)/864e5+e.getDay()-t)/7)};var formatdate=function(){const t=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZWQw]|"[^"]*"|'[^']*'/g,e=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,a=/[^-+\dA-Z]/g,i=function(t,e){for(t=String(t),e=e||2;t.length<e;)t="0"+t;return t};return function(s,r,n){const o=formatdate;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(s)||/\d/.test(s)||(r=s,s=void 0),s=s?new Date(s):new Date,isNaN(s))throw SyntaxError("invalid date");if("UTC:"==(r=String(o.masks[r]||r||o.masks.default)).slice(0,4)&&(r=r.slice(4),n=!0),""==r)return s.getTime();const h=n?"getUTC":"get",l=s[h+"Date"](),d=s[h+"Day"](),c=s[h+"Month"](),g=s[h+"FullYear"](),u=s[h+"Hours"](),m=s[h+"Minutes"](),p=s[h+"Seconds"](),f=s[h+"Milliseconds"](),y=n?0:s.getTimezoneOffset(),_=0==d?6:d-1,D={d:l,dd:i(l),ddd:window.localeNames.days_short[_],dddd:window.localeNames.days_long[_],n:_,W:s.getWeek(1),w:s.getWeek(0),m:c+1,mm:i(c+1),mmm:window.localeNames.month_short[c],mmmm:window.localeNames.month_long[c],yy:String(g).slice(2),yyyy:g,Q:"Q"+Math.floor(s.getMonth()/3%4+1),h:u%12||12,hh:i(u%12||12),H:u,HH:i(u),M:m,MM:i(m),s:p,ss:i(p),l:i(f,3),L:i(f>99?Math.round(f/10):f),t:u<12?"a":"p",tt:u<12?"am":"pm",T:u<12?"A":"P",TT:u<12?"AM":"PM",Z:n?"UTC":(String(s).match(e)||[""]).pop().replace(a,""),o:(y>0?"-":"+")+i(100*Math.floor(Math.abs(y)/60)+Math.abs(y)%60,4)};return r.replace(t,function(t){return t in D?D[t]:t.slice(1,t.length-1)})}}();formatdate.masks={default:"ddd, dd mmm yyyy HH:MM:ss",shortDate:"m.d.yy",mediumDate:"d mmm yyyy",longDate:"d mmmm yyyy",fullDate:"dddd, d mmmm yyyy",shortTime:"H:MM",mediumTime:"HH:MM:ss",longTime:"HH:MM:ss.L",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",week:"W",quater:"Q",datetime:"ddd, d mmmm yyyy HH:MM:ss",millisecond:"HH:MM:ss l",second:"HH:MM:ss",minute:"HH:MM:ss",hour:"ddd, HH:MM",day:"ddd, d.mmm.yy",month:"mmm yyyy",year:"yyyy"};const arrStatistics={max:function(t){return Math.max.apply(null,t)},min:function(t){return Math.min.apply(null,t)},range:function(t){return arr.max(t)-arr.min(t)},midrange:function(t){return arr.range(t)/2},mean:function(t){return _safeParseFloat(arrStatistics.sum(t)/t.length)},sum:function(t){for(var e=0,a=0,i=t.length;a<i;a++)e+=t[a];return _safeParseFloat(e)},last:function(t){return t[t.length-1]},first:function(t){return t[0]}};function deepMerge(...t){let e={};for(const a of t)if(a instanceof Array)e instanceof Array||(e=[]),e=[...e,...a];else if(a instanceof Object)for(let[t,i]of Object.entries(a))i instanceof Object&&t in e&&(i=deepMerge(e[t],i)),e={...e,[t]:i};return e}function compareValues(t,e="asc"){return function(a,i){if(!a.hasOwnProperty(t)||!i.hasOwnProperty(t))return 0;const s="string"==typeof a[t]?a[t].toUpperCase():a[t],r="string"==typeof i[t]?i[t].toUpperCase():i[t];let n=0;return s>r?n=1:s<r&&(n=-1),"desc"===e?-1*n:n}}const capitalize=t=>"string"!=typeof t?"":t.charAt(0).toUpperCase()+t.slice(1);function filter(t,e){let a=[];return e.forEach(e=>{const i=[];i.push(t=>(function(t,e){let a,i;"object"==typeof e?(a=e.key.split("."),i=e.key):(a=e.split("."),i=e);const s=new RegExp(`^${i.replace(/\*/g,".*")}$`,"i");return 0===t.search(s)})(t,e.entity_filter)),i&&i.length&&Object.keys(t).sort().forEach(s=>{if(Object.keys(t[s]).sort(),i.every(t=>t(`${s}`))){let i;if(e.attribute){if(t[s].attributes[e.attribute]){let a=t[s].attributes.friendly_name?t[s].attributes.friendly_name:s;a+=e.name?" "+e.name:" "+capitalize(e.attribute),(i={entity:s,name:a,unit:e.unit||"",state:t[s].attributes[e.attribute.toLowerCase()],attributes:t[s].attributes,last_changed:t[s].last_changed,field:e.attribute.toLowerCase()}).attributes.friendly_name=i.name}}else i={entity:s,name:t[s].attributes.friendly_name?t[s].attributes.friendly_name:s,state:t[s].state,attributes:t[s].attributes,last_changed:t[s].last_changed};if(i)if(e.options&&(i.options=e.options),i.state&&(e.state_min_value||e.state_max_value)){const t=e.state_min_value||Number.MIN_VALUE,s=e.state_max||Number.MAX_VALUE;i.state=parseFloat(i.state),(i.state-t)*(i.state-s)<=0&&a.push(i)}else a.push(i)}})}),a}class DataProvider{constructor(t){this.dataInfo=t.datainfo,this.datascales=t.datascales,this.DEBUGMODE=t.debugmode,this.DEBUGDATA=t.debugdata,this.locale="DE"|window.Chart3.defaults.locale,this.ready=this._checkParam(),this.version="1.0.1"}_checkParam(){return!!(this.datascales&&this.dataInfo.entity_items&&Object.keys(this.dataInfo.entity_items))&&(this.datascales.range=this.datascales.range||24,this.datascales.aggregate=this.datascales.aggregate||"last",!0)}_setEntityServiceDataInformation(t){t&&(t.datascales.data_count=0,t.datascales.servicemode=TRANSFORM_MODE.seriesdata)}_createTimeSeriesData(t,e){return t.seriesdata=t.seriesdata||[],t.seriesdata.data=t.seriesdata.data||[],t.seriesdata.data=Object.entries(e).map(function(e){const a=e[1].data;if(a&&a.length){let i={x:new Date(e[0]).getTime(),localedate:e[1].localedate,y:arrStatistics[t.datascales.aggregate](a)};return t.datascales.useStatistics&&(i.statistics={current:t.state,first:a[0],last:a[a.length-1],max:arrStatistics.max(a),min:arrStatistics.min(a),sum:arrStatistics.sum(a),avg:arrStatistics.mean(a)}),i}}),t.datascales.data_count=t.seriesdata.data.length,t.datascales.data_count}getSimpleData(t){function e(t,e=!1){return e?0!=t&&"unavailable"!=t&&"undefined"!=t&&"unknown"!=t:"unavailable"!=t&&"undefined"!=t&&"unknown"!=t}return t&&t.length&&t.forEach(t=>{const a=t[0].entity_id,i=this.dataInfo.entity_items[a];if(this._setEntityServiceDataInformation(i),a){const a=i.attribute,s=i.factor||1,r=(t=a?t.filter(t=>e(t.attributes[a],i.ignoreZero)):t.filter(t=>e(t.state,i.ignoreZero))).map(t=>a?t.attributes[a]*s:t.state*s);i.datascales.useStatistics&&(_itemdata.statistics={current:i.state,first:r[0],last:r[r.length-1],max:arrStatistics.max(r),min:arrStatistics.min(r),sum:arrStatistics.sum(r),avg:arrStatistics.mean(r)}),i.datascales.data_count=r.length,i.state=arrStatistics[i.datascales.aggregate](r)}}),!0}getSeriesdata(t,e){if(0==this.datascales.mode.history)return this.getSimpleData(t);function a(t,e=!1){return e?0!=t&&"unavailable"!=t&&"undefined"!=t&&"unknown"!=t:"unavailable"!=t&&"undefined"!=t&&"unknown"!=t}function i(t,e="label",a="day"){return formatdate(t,"group"==e?{millisecond:"yyyy/m/d H:M:ss.l",datetime:"yyyy/md/ H:M:s",second:"yyyy/m/d H:M:s",minute:"yyyy/m/d H:M:00",hour:"yyyy/m/d H:00:00",day:"yyyy/m/d",month:"yyyy/m/1",year:"yyyy/12/31"}[a]||"yyyymd":a)}return t&&t.length?(t.forEach(t=>{const e=t[0].entity_id,s=this.dataInfo.entity_items[e];if(e){const e=s.attribute,r=s.factor||1;this._setEntityServiceDataInformation(s),s.hasOwnProperty("ignoreZero")||(s.ignoreZero=!1);let n=[];(t=e?t.filter(t=>a(t.attributes[e],s.ignoreZero)):t.filter(t=>a(t.state,s.ignoreZero))).forEach(function(t){const a=i(t.last_changed,"group",s.datascales.unit);let o=SERIESDEFAULT_VALUE;o=e&&t.attributes&&e in t.attributes?_safeParseFloat(t.attributes[e]):_safeParseFloat(t.state),o*=r,n[a]=n[a]||[],n[a].data=n[a].data||[],n[a].localedate=i(t.last_changed,"label",s.datascales.format||s.datascales.unit),n[a].data.push(_safeParseFloat(o))}),s.datascales.data_count=this._createTimeSeriesData(s,n)}}),!0):void 0}}const DEFAULT_COLORS=["rgba(237,212,0,0.85)","rgba(115,210,22,0.85)","rgba(245,121,0,0.85)","rgba(52,101,164,0.85)","rgba(89,161,79,0.85)","rgba(182,153,45,0.85)","rgba(73,152,148,0.85)","rgba(225,87,89,0.85)","rgba(121,112,110,0.85)","rgba(211,114,149,0.85)","rgba(176,122,161,0.85)","rgba(157,118,96,0.85)","rgba(52,152,219,0.85)","rgba(46,204,113,0.85)","rgba(241,196,15,0.85)","rgba(155,89,182,0.85)","rgba(26,188,156,0.85)","rgba(39,174,96,0.85)","rgba(41,128,185,0.85)","rgba(142,68,173,0.85)","rgba(44,62,80,0.85)","rgba(230,126,34,0.85)","rgba(231,76,60,0.85)","rgba(236,240,241,0.85)","rgba(149,165,166,0.85)","rgba(243,156,18,0.85)","rgba(211,84,0,0.85)","rgba(192,57,43,0.85)","rgba(229,28,35,0.85)","rgba(205,220,57,0.85)","rgba(52,152,219,0.85)","rgba(231,76,60,0.85)","rgba(155,89,182,0.85)","rgba(241,196,15,0.85)","rgba(46,204,113,0.85)","rgba(26,188,156,0.85)","rgba(52,73,94,0.85)","rgba(230,126,34,0.85)","rgba(127,140,141,0.85)","rgba(39,174,96,0.85)","rgba(41,128,185,0.85)","rgba(142,68,173,0.85)"],COLOR_RADARCHART="rgba(41, 182, 246, 0.45)",COLOR_BUBBLECHAT="rgba(255, 152, 0, 0.685)",randomColor="#"+Math.floor(16777215*Math.random()).toString(16);class chartData{constructor(t){this.card_config=t.card_config,this.entity_options=t.entityOptions,this.entity_items=t.entity_items,this.DEBUGMODE=t.debugmode,this.data_pointStyles=CT_DATAPOINTSTYLE,this.indicators={up:"▲",down:"▼",equal:"≃"},this.graphData={},this.version="1.0.1"}getDefaultGraphData(){return{data:{datasets:[]},config:{mode:"init",secondaryAxis:!1,series:0,gradient:!1,options:{},segmentbar:!1,timescale:!1}}}createScatterChartData(){if(!this.entity_items.isValid)return null;let t=null,e=this.entity_items.getSize(),a=this.entity_items.getEntitieslist();if(e%2==0){(t=this.getDefaultGraphData()).config.mode="simple";for(let i=0;i<e;i+=2){const e=this.entity_items.getOptions(i);let s={label:a[i].name||"",unit:a[i].unit||"",hoverRadius:20,radius:15,pointRadius:15,hitRadius:20,backgroundColor:e.backgroundColor||DEFAULT_COLORS[20+5*i],borderColor:e.borderColor||DEFAULT_COLORS[20+5*i]};this.entity_options&&(s={...this.entity_options,...s},t.config.options=this.entity_options),this.entity_options&&void 0!==this.entity_options.gradient&&(t.config.gradient=!0),s.data=[{x:a[i].state||0,y:a[i+1].state||0}],e&&(s={...s,...e}),t.data.datasets.push(s)}t.config.options.scatter=!0}else console.error("ScatterChart setting not valid ",a);return t}createBubbleChartData(){if(!this.entity_items.isValid)return null;let t=null,e=this.entity_items.getSize(),a=this.entity_items.getEntitieslist();if(e%3==0){(t=this.getDefaultGraphData()).config.mode="simple";for(let e=0;e<a.length;e+=3){const i=this.entity_items.getOptions(e+1);let s={label:a[e+2].name||"",scale:i.scale||1,unit:a[e+2].unit||"",backgroundColor:i.backgroundColor||DEFAULT_COLORS[24+5*e],borderColor:i.borderColor||DEFAULT_COLORS[24+5*e]};this.entity_options&&(s={...this.entity_options,...s},t.config.options=this.entity_options),this.entity_options&&void 0!==this.entity_options.gradient&&(t.config.gradient=!0),i&&i.pointStyle&&(s.pointStyle=i.pointStyle,s.pointRadius=6),i&&i.pointRadius&&(s.pointRadius=i.pointRadius),s.data=[{x:a[e].state||0,y:a[e+1].state||0,r:a[e+2].state||0}],i&&(s={...s,...i}),t.data.datasets.push(s)}t.config.options.bubble=!0}else console.error("BubbleChart setting not valid",a);return t}createSimpleBarSegmentedData(t){if(t.data&&t.data.length){t.data=t.data.map(t=>Number(t));const e=Math.max(...t.data),a=(Math.min(...t.data),Chart.helpers);return{data:t.data.map(t=>e-t),backgroundColors:t.backgroundColor.map(t=>a.color(t).alpha(.25).rgbString())}}}createChartData(){if(!this.entity_items.isValid)return null;const t=this.entity_items.getData();if(0===t.length)return console.error("Create Chart Data, no Data present !"),null;let e={mode:"current",unit:""},a=this.getDefaultGraphData();a.config.mode="simple",this.entity_options&&(e={...e,...this.entity_options}),a.data.labels=this.entity_items.getNames(),a.data.datasets[0]=e,a.data.datasets[0].label=this.card_config.title||"",this.entity_options&&this.entity_options.unit?a.data.datasets[0].unit=this.entity_options.unit||"":a.data.datasets[0].units=this.entity_items.getEntitieslist().map(t=>t.unit),"horizontalbar"===this.card_config.chart&&(a.data.datasets[0].indexAxis="y");let i=this.entity_items.getColors();if(this.entity_options&&null!=this.entity_options.gradient&&(a.config.gradient=!0),i.length===a.data.labels.length?(a.data.datasets[0].backgroundColor=i,a.data.datasets[0].showLine=!1):"radar"===this.card_config.chart?(a.data.datasets[0].backgroundColor=COLOR_RADARCHART,a.data.datasets[0].borderColor=COLOR_RADARCHART,a.data.datasets[0].borderWidth=1,a.data.datasets[0].pointBorderColor=COLOR_RADARCHART,a.data.datasets[0].pointBackgroundColor=COLOR_RADARCHART,a.data.datasets[0].tooltip=!0,a.config.gradient=!1):(i=DEFAULT_COLORS.slice(1,t.length+1),a.data.datasets[0].backgroundColor=i,a.data.datasets[0].borderWidth=0,a.data.datasets[0].showLine=!1),a.data.datasets[0].data=t,a.config.segmentbar=!1,"bar"===this.card_config.chart&&this.card_config.chartOptions&&this.card_config.chartOptions.segmented){const t=this.createSimpleBarSegmentedData(a.data.datasets[0]);t&&(a.data.datasets[1]={},a.data.datasets[1].data=t.data,a.data.datasets[1].tooltip=!1,a.data.datasets[1].backgroundColor=t.backgroundColors,a.data.datasets[1].borderWidth=0,a.data.datasets[1].showLine=!1,a.config.segmentbar=0!==t.data.length)}return a}getCurrentGraphData(){try{switch(this.card_config.chart){case"bubble":this.graphData=this.createBubbleChartData();break;case"scatter":this.graphData=this.createScatterChartData();break;default:this.graphData=this.createChartData()}return this.graphData}catch(t){console.error("Current entities GraphData",t.message,t)}return null}createHistoryBubbleData(){if(!this.entity_items.isValid)return null;let t=this.entity_items.getSeriesData();if(t&&t.length%3==0){let e=this.getDefaultGraphData();for(let a=0;a<t.length;a+=3){const i=this.entity_items.getOptions(a+2)||{};let s=[];t[a].data.forEach(function(e,i){t[a+1].data[i]&&t[a+2].data[i]&&s.push({x:parseFloat(t[a+0].data[i].y)||0,y:parseFloat(t[a+1].data[i].y||0),r:parseFloat(t[a+2].data[i].y||0)})});let r={label:this.entity_items.getEntity(a+2).name||"",unit:this.entity_items.getEntity(a+2).unit||"",scale:this.entity_items.getEntity(a+2).scale||1,backgroundColor:i.backgroundColor||DEFAULT_COLORS[17+5*a],borderColor:i.borderColor||DEFAULT_COLORS[17+5*a]};i&&i.pointStyle&&(r.pointStyle=i.pointStyle,r.pointRadius=6),i&&i.pointRadius&&(r.pointRadius=i.pointRadius),this.entity_options&&(r={...r,...this.entity_options},e.config.options=this.entity_options),i&&(r={...r,...i}),r.data=s,e.data.datasets.push(r)}if(e.data.datasets.length)return e.config.options.bubble=!0,e}return console.error("BubbleChart setting not valid for ",this.entity_items.getNames()),null}createHistoryScatterData(){if(!this.entity_items.isValid)return null;let t=this.entity_items.getSeriesData();if(t&&t.length%2==0){let e=this.getDefaultGraphData();e.config.mode="history";for(let a=0;a<t.length;a+=2){const i=this.entity_items.getOptions(a)||{};let s=[];t[a].data.forEach(function(e,i){t[a].data[i]&&t[a+1].data[i]&&s.push({x:parseFloat(t[a+0].data[i].y)||0,y:parseFloat(t[a+1].data[i].y||0)})});let r={label:this.entity_items.getEntity(a).name||"",unit:this.entity_items.getEntity(a).unit||"",hoverRadius:18,pointRadius:16,hitRadius:22,backgroundColor:i.backgroundColor||DEFAULT_COLORS[27+5*a],borderColor:i.borderColor||DEFAULT_COLORS[27+5*a]};this.entity_options&&(r={...r,...this.entity_options},e.config.options=this.entity_options),i&&(r={...r,...i}),r.data=s,e.data.datasets.push(r)}if(e.data.datasets.length)return e.config.options.bubble=!0,e}return console.error("ScatterChart setting not valid for ",this.entity_items.getNames()),null}createHistoryChartData(){let t=this.getDefaultGraphData();return t.config.options.fill=!1,t.config.mode="history",this.entity_items.getEntityIds().forEach(e=>{const a=this.entity_items.items[e];let i={...this.entity_items.getOptions(a.entity)},s={label:a.name||"unkonwn",unit:a.unit||"",pointRadius:0,current:a.state||0,last_changed:a.last_changed||new Date,mode:"history"};if("horizontalbar"===this.card_config.chart&&(s.indexAxis="y"),"radar"===this.card_config.chart&&(s.pointRadius=12,s.hoverRadius=18,s.hitRadius=22),this.entity_options&&(s={...s,...this.entity_options},t.config.options={...t.config.options,...this.entity_options}),s={...s,...i},t.config.options.fill=i.fill||CT_BARCHARTS.includes(this.card_config.chart),i.fill&&i.gradient&&i.gradient.colors){const e="y"===s.indexAxis?"x":"y";s.gradient={backgroundColor:{axis:e,colors:i.gradient.colors}},s.labelcolor=i.gradient.colors[0],s.borderColor=i.gradient.colors[0]||DEFAULT_COLORS[t.config.series],t.config.gradient=!0}else void 0===i.backgroundColor&&(s.backgroundColor=DEFAULT_COLORS[t.config.series],s.borderColor=DEFAULT_COLORS[t.config.series]);if(t.config.secondaryAxis||(t.config.secondaryAxis=null!=i.yAxisID||null!=i.xAxisID),0==t.config.options.mode.timeaxis){const a=this.entity_items.getDataset(e);t.config.multiseries=!1,a&&a.data&&(t.data.labels=a.labels,"pie"!=this.card_config.chart&&"doughnut"!=this.card_config.chart||(t.data.labels=this.entity_items.getNames(),t.config.multiseries=!0),s.data=a.data,t.config.useTimeSeries=t.config.options.mode.timescale)}else a.seriesdata&&a.seriesdata.data&&(s.data=a.seriesdata.data,t.config.datascales=a.datascales,t.config.timescale=t.config.options.mode.timescale);t.data.datasets.push(s),t.config.series++}),t}getHistoryGraphData(){try{switch(this.card_config.chart){case"bubble":this.entity_options.mode=CT_DATASCALEMODES[this.card_config.chart],this.graphData=this.createHistoryBubbleData();break;case"scatter":this.entity_options.mode=CT_DATASCALEMODES[this.card_config.chart],this.graphData=this.createHistoryScatterData();break;case"bar":case"horizontalbar_":this.entity_options&&this.entity_options.mode&&this.entity_options.mode.history?this.graphData=this.createHistoryChartData():this.graphData=this.createChartData();break;case"pie":this.entity_options&&this.entity_options.mode&&this.entity_options.mode.history?this.graphData=this.createHistoryChartData():(this.entity_options.mode=CT_DATASCALEMODES[this.card_config.chart],this.graphData=this.createChartData());break;case"doughnut":this.entity_options.mode=CT_DATASCALEMODES[this.card_config.chart],this.graphData=this.createChartData();break;default:this.graphData=this.createHistoryChartData()}if(this.graphData)return this.graphData;console.error("Error getHistoryGraphData, no data present!")}catch(t){console.error("Build History GraphData",t.message,t)}return null}}function xAxisFormat(t,e,a){if(this&&this.options.time&&this.options.time.unit){const e=this.options.time.format||this.options.time.unit;if(e&&Number.isInteger(t))return formatdate(+t,e)}return t}function yAxisFormat(t,e,a){return t}function formatToolTipTitle(t){const e=t[0].chart.config._config.type;return"polarArea"==e?t[0].chart.config._config.data.labels[t[0].dataIndex]||"":"scatter"==e?"":t[0].label&&t[0].raw&&t[0].raw.localedate?t[0].raw.localedate||t[0].label:t[0].label||""}function formatToolTipLabel(t){if(!1===t.dataset.tooltip)return null;let e=t.dataset.label||t.label||t.chart.data.labels[t.dataIndex]||"";const a="bubble"===t.chart.config._config.type?t.parsed._custom:t.formattedValue;return t.dataset.units&&t.dataset.units.length>t.dataIndex?e+=`: ${a}  ${t.dataset.units[t.dataIndex]||""}`:e+=`: ${a}  ${t.dataset.unit||""}`,e}class graphChart{constructor(t){this.ctx=t.ctx||null,this.canvasId=t.canvasId,this.entity_items=t.entity_items,this.chart_type=t.chart_type||"bar",this.chartconfig=t.chartconfig||{},this.loader=t.loader,this.DEBUGMODE=t.debugmode||0,this.DEBUGDATA=t.debugdata,this.chart=null,this.graphData={},this.graphDataSets=[],this.chart_ready=!1,this.lastUpdate=null,this.ChartControl=window.Chart3||Chart,this.version="1.0.1"}_setChartOptions(){const t=this.loader;let e={hoverOffset:8,layout:{},interaction:{mode:"nearest",intersect:!1},chartArea:{backgroundColor:"transparent"},elements:{},spanGaps:!0,plugins:{title:{},tooltip:{},legend:{display:CT_SHOWLEGEND.includes(this.chart_type.toLowerCase())||!1}},animation:{onComplete:function(){t&&(t.style.display="none")}},onResize:null};if(!0===this.graphData.config.gradient&&"simple"===this.graphData.config.mode&&(e.gradientcolor={color:!0,type:this.chart_type}),gradient&&this.graphData.config.gradient&&(e.plugins={gradient:gradient}),this.graphData.config.secondaryAxis&&this.graphData&&this.graphData.data&&this.graphData.data.datasets){let t={};this.graphData.data.datasets.forEach(e=>{e.yAxisID&&(t[e.yAxisID]={},t[e.yAxisID].id=e.yAxisID,t[e.yAxisID].type="linear",t[e.yAxisID].position=e.yAxisID,t[e.yAxisID].display=!0,"right"==e.yAxisID.toLowerCase()&&(t[e.yAxisID].grid={drawOnChartArea:!1})),e.xAxisID&&(t[e.xAxisID]={},t[e.xAxisID].id=e.xAxisID,t[e.xAxisID].type="linear",t[e.xAxisID].position=e.xAxisID,t[e.xAxisID].display=!0,"top"==e.xAxisID.toLowerCase()&&(t[e.xAxisID].grid={drawOnChartArea:!1}))}),t&&(e.scales=t)}if("bubble"===this.chart_type.toLowerCase()){const t=this.entity_items.getEntitieslist();let a=t[0].name;a+=t[0].unit?" ("+t[0].unit+")":"";let i=t[1].name;i+=t[1].unit?" ("+t[1].unit+")":"",e.scales={x:{id:"x",title:{display:!0,text:a}},y:{id:"y",title:{display:!0,text:i}}},this.graphData.config.bubbleScale&&(e.elements={point:{radius:t=>{return t.dataset.data[t.dataIndex]._r*this.graphData.config.bubbleScale}}})}this.graphData.config.timescale&&this.graphData.config.datascales&&(e.scales=e.scales||{},e.scales.x=e.scales.x||{},e.scales.x.maxRotation=0,e.scales.x.autoSkip=!0,e.scales.x.major=!0,e.scales.x.type="time",e.scales.x.time={unit:this.graphData.config.datascales.unit,format:this.graphData.config.datascales.format,isoWeekday:this.graphData.config.datascales.isoWeekday},e.scales.x.ticks={callback:xAxisFormat}),e.plugins.tooltip={callbacks:{label:formatToolTipLabel,title:formatToolTipTitle}},!0===this.graphData.config.segmentbar&&(e.scales={x:{id:"x",stacked:!0},y:{id:"y",stacked:!0}},e.plugins.legend={display:!1,labels:{filter:(t,e)=>!1!==e.datasets[t.datasetIndex].tooltip}}),"bubble"===this.chart_type.toLowerCase()&&(e.plugins.legend={display:!1}),!0===this.graphData.config.multiseries&&(e.plugins.legend={labels:{generateLabels:function(t){const e=Chart.overrides.pie.plugins.legend.labels.generateLabels.call(this,t);var a=t.data.datasets.map(function(t){return t.backgroundColor});return a=a.flat(),e.forEach(e=>{e.datasetIndex=(e.index-e.index%2)/2,e.hidden=!t.isDatasetVisible(e.datasetIndex),e.fillStyle=a[e.index]}),e}},onClick:function(t,e,a){a.chart.getDatasetMeta(e.datasetIndex).hidden=a.chart.isDatasetVisible(e.datasetIndex),a.chart.update()}},e.plugins.tooltip={callbacks:{label:function(t){const e=t.datasetIndex+t.dataIndex;return t.chart.data.labels[e]+": "+t.formattedValue}}});let a={type:this.chart_type,data:{datasets:[]},options:e};return this.chartconfig.options?a.options=deepMerge(e,this.chartconfig.options):a.options=e,a}sendJSON(t,e){let a=new XMLHttpRequest;a.open("POST",t,!0),a.setRequestHeader("Content-Type","application/json"),a.onreadystatechange=function(){4===a.readyState&&200===a.status&&console.info("sendJson",this.responseText)};var i=JSON.stringify(e);console.info(i),a.send(i)}renderGraph(t){try{if(this.graphData&&this.graphData.data&&this.graphData.config){if(this.graphDataSets&&this.graphDataSets.length&&JSON.stringify(this.graphDataSets)===JSON.stringify(this.graphData.data.datasets))return;let e=this._setChartOptions();e.data={datasets:this.graphData.data.datasets},this.graphData.data.labels&&(e.data.labels=this.graphData.data.labels),this.ctx&&e.data&&e.options&&(t&&this.chart&&this.chart.data?(this.chart.data=e.data,this.chart.update({duration:0,easing:"linear"}),this.DEBUGMODE&&(this.DEBUGDATA.CHARD={chartOptions:e,chartMode:"update data ready",chartjs:window.Chart3.version,chartGraphdata:this.graphData.config})):(!1===this.chart_ready&&this.ChartControl.register&&(this.graphData.config.gradient&&this.ChartControl.register(gradient),this.ChartControl&&this.chartconfig&&this.chartconfig.options&&this.chartconfig.options.chartArea&&""!==this.chartconfig.options.chartArea.backgroundColor&&this.ChartControl.register({id:"chardbackground",beforeDraw:function(t){if(t.config.options.chartArea&&t.config.options.chartArea.backgroundColor){const e=t.chartArea,a=t.ctx;a.save(),a.fillStyle=t.config.options.chartArea.backgroundColor,a.fillRect(e.left,e.top,e.right-e.left,e.bottom-e.top),a.restore()}}})),this.chart&&(this.chart.destroy(),this.chart=null),this.DEBUGMODE&&(this.DEBUGDATA.CHARD={},this.DEBUGDATA.CHARD.cart3Options=e),this.chart=new window.Chart3(this.ctx,e),this.graphDataSets=this.graphData.data.datasets,this.DEBUGMODE&&(this.DEBUGDATA.CHARD={chartOptions:e,chartMode:"new data ready",chartjs:window.Chart3.version,chartmodul:"v "+this.version,chartGraphdata:this.graphData.config}),this.chart&&(this.chart_ready=!0)))}else console.error("Fatal Error, missing graphdata",graphOptions)}catch(t){console.error("Error Render Graph Error on ",this.chart_type,": ",t,t.message)}}}